# 文件在线预览与水印（V1 定稿）## 1 范围与目标- 文件上传存 S3（raw）- 预览输出为带水印的 PDF/图片（preview）- 外协必须：满屏斜向水印 + 图像化PDF（不可复制文本）- 预览与下载权限分离：外协永远不可下载 raw---## 2 S3 存储规范- raw/{group_id}/{yyyy}/{mm}/{file_id}/{filename}- preview/{group_id}/{yyyy}/{mm}/{file_id}/{user_id}/{variant}.pdfvariant:- internal（内部）- client（客户）- external（外协）---## 3 预览 token- 10 分钟有效、一次性- token 绑定：user_id + file_id + variant + expire_at- 预览入口：GET /preview/{token}必须审计：- Preview.TokenCreated- Preview.Viewed---## 4 渲染与水印### 4.1 统一转换- doc/docx -> LibreOffice headless -> pdf- png/jpg -> 作为图片页 -> pdf（可选）- pdf -> 原样输入### 4.2 水印策略（强制）- internal：轻水印（角落 + 淡斜向）- client：中水印（明显但不影响阅读）- external：强水印（满屏斜向、密度高）+ 图像化 PDF### 4.3 外协“不可复制文本PDF”的实现- 将输入 PDF 每页渲染成图片（150~200 dpi）- 在图片上叠加满屏斜向水印- 将图片重新封装成 PDF结果：无文本层，无法复制文本（但仍无法防截图，需审计与追责）---## 5 缓存策略- 缓存Key：file_sha256 + user_id + variant + wm_ver- preview 产物缓存 24h 或按容量清理- 注意：水印包含用户信息，必须按 user_id 粒度区分缓存---## 6 权限规则（必须）- internal：按资源域 + 动作权限判定- external：只允许预览，永远禁下载- client：仅预览客户可见文件类型；回款凭证默认不可预览（V2 可做申请）---## 7 最小接口规范- POST /files/upload-init- POST /files/upload-complete- POST /files/{file_id}/preview-token- GET  /preview/{token}- GET  /files/{file_id}/download-url（internal only）