# Outbox 与幂等策略（V1 定稿）## 1 目标- 保证业务写入在网络重试/重复点击/worker重启情况下不产生重复副作用- 支持事件驱动：通知、预警、审计补强、预览生成等---## 2 三层幂等### 2.1 API 请求幂等（Idempotency-Key）#### 规则- 所有产生副作用的 POST/PUT 必须支持 Idempotency-Key- key 建议前端生成 uuid，放 header：Idempotency-Key- 服务端存储： (user_id, key, request_hash, response_snapshot, expires_at)- TTL 建议 24 小时#### 必须支持幂等的接口（V1）- 指令下发（避免重复生成任务）- 回款新增- 回款更正申请/执行- 文件 upload-complete- 结案申请、审批动作- 导出触发（如有）---### 2.2 Outbox 去重（dedupe_key）#### event_outbox 字段- event_id (uuid pk)- event_type- dedupe_key (unique)- payload(jsonb)- status(pending/processing/done/failed)- retry_count- created_at/processed_at#### dedupe_key 规则（固定模板）dedupe_key = `{event_type}:{object_type}:{object_id}:v{version}`例：- Instruction.Issued:instruction:{instruction_id}:v{version}- Task.Assigned:task:{task_id}:v1- Payment.Corrected:payment:{new_payment_id}:v1- Preview.GenerateRequested:file:{file_id}:user:{user_id}:variant:{variant}:wm:{wm_ver}:sha:{file_sha}必须在 DB 上建立 UNIQUE(dedupe_key)。---### 2.3 Worker handler 去重（event_consumption）- 表：event_consumption(event_id, handler_name, status, consumed_at)- UNIQUE(event_id, handler_name)流程：1) handler 开始前 INSERT event_consumption2) 若冲突则说明处理过 → skip3) 成功处理后更新 status=done4) 失败记录 status=failed（可重试策略按 outbox）---## 3 Worker 消费并发### 3.1 拉取 pending（推荐 SQL）- SELECT ... FROM event_outbox  WHERE status='pending'  ORDER BY created_at  LIMIT N  FOR UPDATE SKIP LOCKED;拉取后标记 processing，避免重复处理。### 3.2 重试- 指数退避：1m/2m/5m/10m/30m/1h...- retry_count 超过阈值（建议 8）→ status=failed- failed 事件必须告警（日志 + 通知管理员）---## 4 预览生成幂等（强烈建议）预览生成容易重复，必须额外保证：- 缓存Key：file_sha256 + user_id + variant + wm_ver- 表：preview_index(file_id, user_id, variant, wm_ver, preview_object_key) UNIQUE- 生成前先查 preview_index；命中直接返回