智慧执行协作平台：工程指导与约束（给 VS + GitHub Copilot Pro 使用）0 目标与红线0.1 目标V1 用 Postgres + RLS 实现战区（group_id）硬隔离用 模块化单体 + worker 快速交付并保持边界，V2/V3 可拆服务不返工用 Outbox 实现事件驱动（通知/预警/审计/预览生成）外协预览：满屏斜向水印 + 图像化PDF（不可复制文本）客户端显示回款明细：必须有更正链与审计0.2 红线（任何代码不得违反）严禁绕过 RLS：所有数据访问必须使用同一 DB 连接与 session 变量注入流程严禁直接修改 Payment 核心字段（金额/日期/渠道等），必须走更正链（新记录）外协：永远禁下载、禁导出、禁解密客户端 API：字段白名单输出，绝不复用内部 API 响应对象所有写操作必须审计（至少：审批/导出/下载/更正/权限变更/预览）1 总体架构约束（必须遵守）1.1 部署单元api-service：模块化单体worker-service：异步任务（outbox、通知、预览、水印、导出、预警）postgres（RLS）/ redis / S31.2 单体内模块边界（目录结构必须体现）identity_accesslead_crmevaluationproject_caseintel_instructionexecution_opsdisputeservice_csfile_serviceaudit_compliancenotificationinfra（db/redis/s3/outbox/preview）约束：模块内可写本模块表；跨模块写必须通过 service 层方法，不允许跨模块直接写表。Controller 只做参数校验与调用 service，不直接写 SQL，不直接拼业务对象。1.3 事务边界“一次业务动作”必须在同一 DB 事务内完成：业务写入 + 审计写入（同步）+ outbox 写入outbox 消费与业务写入分离（worker）2 数据与安全模型（RLS 强制）2.1 会话变量注入（每个请求必须设置）app.user_idapp.is_adminapp.group_ids（逗号分隔uuid）（可选）app.actor_type=user/worker2.2 RLS 规则（必须实现）所有核心表必须启用 RLS：project、case、task、payment、instruction、evidence、file_store、audit_log、notification、complaint、temp_grant、case_member、project_member、event_outboxSELECT policy：admin 或 group_id 命中 或 case_member/temp_grant 命中INSERT/UPDATE policy：禁止写入/迁移到非本战区 group_id（admin 除外）2.3 group_id 继承规则（禁止手填乱传）case.group_id 继承 project.group_idtask/payment/evidence/file_store.group_id 继承 case.group_idAPI 层不得信任前端传来的 group_id（后端计算并覆盖）3 领域对象与不可变约束3.1 主对象关系（不得改动）Project 1—N CaseCase 1—N TaskProject/Case 1—N InstructionCase 1—N Payment（Payment 必绑 Case，冗余 project_id）3.2 Payment 不可变约束（强制）禁止 UPDATE 核心字段：amount/paid_at/pay_channel/payer_name/bank_last4/case_id/project_id/group_id更正必须：创建新 payment + old 标记 corrected + new.corrected_from_payment_id 指向 oldDB 必须有触发器防止核心字段更新（即使开发写错也会失败）4 Outbox 与幂等（必须实现）4.1 Outbox 表字段event_id(uuid PK)event_typededupe_key（唯一索引）group_id/project_id/case_id/actor_user_idpayload(jsonb)status(pending/processing/done/failed)retry_count/processed_at4.2 事务写 outbox每个业务动作在同一事务插入 outboxdedupe_key 规则固定：{event_type}:{object_type}:{object_id}:v{version}4.3 API 幂等所有关键 POST/PUT 必须支持 Idempotency-KeyRedis 或 DB 存储 (user_id, key) → 返回第一次响应，TTL 24h4.4 Worker 幂等消费：FOR UPDATE SKIP LOCKEDhandler 去重：event_consumption(event_id, handler_name) 唯一索引失败重试：指数退避 + 超限转 failed（告警）5 文件、预览与水印（外协强策略）5.1 S3 Key 规范raw/{group_id}/{yyyy}/{mm}/{file_id}/{filename}preview/{group_id}/{yyyy}/{mm}/{file_id}/{user_id}/{variant}.pdf5.2 预览 token10 分钟有效、一次性token 绑定：user_id + file_id + variant + expire_at5.3 水印策略（V1必须）内部：轻水印客户：中水印外协：强水印（满屏斜向、密度高）+ 图像化PDF（不可复制文本）实现约束：外协预览产物必须由“逐页渲染成图片→叠水印→合成PDF”生成外协永远禁下载 raw 文件5.4 审计（必做）preview_token_create / preview_view / download_url_generate / upload_complete 都要写 audit_log6 API 规范（Copilot 生成代码的统一模板）6.1 分层Controller：只做 DTO 校验与调用 serviceService：业务规则 + 事务 + 写 outbox + 写审计Repository：仅数据访问，不包含业务规则Policy：权限（动作/资源/字段）统一入口6.2 错误码规范401 未登录403 无权限（含外协禁下载、跨战区）404 资源不可见（不要泄露存在性）409 幂等冲突/重复提交422 字段校验失败500 内部错误（必须记录request_id）6.3 客户端 API 独立命名空间/client/** 只返回字段白名单 DTO禁止复用内部 DTO7 编码规范（强制）7.1 命名表：snake_caseAPI：kebab-case 或 snake_case 统一（建议 REST 风格）事件：PascalCase 或 dot 风格统一（建议 Payment.Corrected）7.2 日志与审计每个请求生成 request_id写审计时必须写：actor_user_id、action、object_type、object_id、group_id、timestamp7.3 代码生成约束（给 Copilot 的“不要做什么”）不要写任何绕过 RLS 的 SQL（例如直接用超级用户连接）不要把 group_id 当参数信任前端不要在 Controller 里写事务不要直接 UPDATE payment 核心字段不要把客户/外协的返回对象与内部共用8 测试要求（必须）8.1 单元测试payment 不可变（更新核心字段会失败）dedupe_key 唯一约束生效幂等 Key 重放返回一致响应8.2 集成测试（最重要）RLS：战区A用户无法读到战区B数据case_member：跨战区承办可读指定 case，但不可修改未授权字段外协：可预览强水印图像化PDF、不可下载客户端：只能看白名单字段、回款更正后只显示新记录9 Git 工作流与交付规范（建议）main：可发布dev：集成feature/*：功能分支每个 PR 必须包含：迁移脚本 + API变更说明 + 测试用例commit message：feat: ... / fix: ... / chore: ...10 交付“最小骨架”清单（Copilot 第一周必须生成）DB schema + migration（含RLS、触发器、索引）auth（短信登录+用户名）middleware：注入 app.* session variablesproject/case CRUD 最小集（带 RLS）outbox + worker 骨架（SKIP LOCKED + consumption 去重）file upload（S3预签名）+ preview token + 预览水印管线骨架payment 新增 + 更正链 API（含触发器保护）audit_log 写入（统一 helper）11 “Copilot 提示词模板”（你可以直接粘给它）“在遵守 docs/ENGINEERING_GUIDE.md 的所有红线前提下，为模块 X 实现 Y。所有 DB 访问必须依赖 RLS session 变量，所有写操作必须写 audit_log 并插入 outbox。禁止直接更新 payment 核心字段；外协预览必须输出图像化 PDF + 满屏斜向水印。”